<% if (tripMode === 'current' || tripMode === 'upcoming') { %>

<%- include('gallery/current-upcoming',{ media }) %>

<% } else { %>

<%- include('gallery/past-trips', { media }) %>

<% } %>

<script>

    document.body.addEventListener('htmx:afterSwap', function (e) {
        const isTagEditorSwap = e.target.id?.startsWith?.('tag-editor-');
        if (!isTagEditorSwap) return;

        const mediaId = e.target.dataset.mediaId;
        if (!mediaId) return;

        const current = document.getElementById('lightbox-metadata');
        if (!current) return;

        // let's update the lightbox meta data for the media item that is
        // actually being viewed and not another one.
        // only refresh lightbox metadata if the swap came from editing tags
        if (current.dataset.mediaId === mediaId) {
            htmx.ajax('GET', `/trips/<%= currentOrUpcomingTrip.slug %>/gallery/${mediaId}/lightbox-data`, {
                target: '#lightbox-meta'
            });
            const dialog = document.getElementById('lightbox-tag-editor-modal');
            dialog.classList.add('hidden');
        }
    });
    // after the tags were edited, either in the hover menu or lightbox
    // fire this event to we can re-fetch the filter-pills

    document.body.addEventListener('htmx:afterOnLoad', function (evt) {
        debugger;
        // Check if the target element is a tag editor that was just updated
        if (evt.target && evt.target.id && evt.target.id.startsWith('tag-editor-')) {
            document.body.dispatchEvent(new CustomEvent('tags-updated'));
        }
    });

    document.body.addEventListener('tags-updated', () => {
        debugger;
        // if tags were updated either on the hover menu or the lightbox
        // then we must update the pill-filters
        let url = `/trips/<%= currentOrUpcomingTrip.slug %>/gallery/filter-pills`;
        let options = { target: `#filter-pills`, swap: 'innerHTML' };
        htmx.ajax('GET', url, options);


        // HTMX load new filtered media
        // selectedTagId is a global variable
        // if the tags were updated, then we might need to update the media items
        // that are being filtered (if selectedTagId != -1)
        if (selectedTagId != -1) {
            url = `/trips/<%= currentOrUpcomingTrip.slug %>/gallery?sort=${selectedTagId}`;
            htmx.ajax('GET', url, {
                target: '#media-grid',
                swap: 'innerHTML'
            });
        }
    });
</script>