<style>
    .filter-container {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .filter-container.hidden {
        display: none;
    }

    .filter-row {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-label {
        font-size: 0.85rem;
        font-weight: bold;
        color: #333;
    }

    .pill-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .sorting-pill {
        font-size: 0.6rem;
        padding: 0.25rem 0.55rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.15);
        border: 1px solid var(--accent-1);
        color: black;
        cursor: pointer;
        font-weight: 600;
        white-space: nowrap;
        letter-spacing: 0.3px;
        display: inline-block;
        transition: background-color 0.2s;
    }

    .sorting-pill.active {
        background-color: rgba(255, 255, 255, 0.7);
        color: red;
        font-weight: bold;
    }

    .sort-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem 0.4rem;
        align-items: center;
        margin-bottom: 0.4rem;
        line-height: 1;
    }

    .sort-options span:first-child {
        font-weight: bold;
        font-size: 0.75rem;
        margin-right: 0.4rem;
    }

    .sorting-pill:hover {
        background-color: rgba(255, 255, 255, 0.3);
    }
</style>

<div id="filter-pills">
    <%- include('filter-pills') %>
</div>

<script>

    document.getElementById('default-tag-pill').classList.add('active');
    document.getElementById('default-author-pill').classList.add('active');
    document.getElementById('default-sort-pill').classList.add('active');

    document.getElementById('filter-pills')?.addEventListener('click', (e) => {
        if (e.target.classList.contains('tag-pill')) {
            // Update selected tag
            galleryState.selectedTagId = e.target.dataset.tag;

            // Update pill UI
            document.querySelectorAll('.sorting-pill.tag-pill').forEach(p => p.classList.remove('active'));
            e.target.classList.add('active');

            // HTMX load new filtered media
            const url = `/trips/<%= currentOrUpcomingTrip.slug %>/gallery?tag=${galleryState.selectedTagId}&author=${galleryState.selectedAuthor}&sort=${galleryState.selectedSortCriteria}`;
            htmx.ajax('GET', url, {
                target: '#media-grid',
                swap: 'innerHTML'
            });
        }
        else if (e.target.classList.contains('author-pill')) {
            // Update selected tag
            galleryState.selectedAuthor = e.target.dataset.author;

            // Update pill UI
            document.querySelectorAll('.sorting-pill.author-pill').forEach(p => p.classList.remove('active'));
            e.target.classList.add('active');

            // HTMX load new filtered media
            const url = `/trips/<%= currentOrUpcomingTrip.slug %>/gallery?tag=${galleryState.selectedTagId}&author=${galleryState.selectedAuthor}&sort=${galleryState.selectedSortCriteria}`;
            htmx.ajax('GET', url, {
                target: '#media-grid',
                swap: 'innerHTML'
            });
        }
        else if (e.target.classList.contains('sort-pill')) {
            // Update selected sort criteria
            galleryState.selectedSortCriteria = e.target.dataset.sort;

            // Update pill UI
            document.querySelectorAll('.sort-pill.sort-pill').forEach(p => p.classList.remove('active'));
            e.target.classList.add('active');

            // HTMX load new filtered media
            const url = `/trips/<%= currentOrUpcomingTrip.slug %>/gallery?tag=${galleryState.selectedTagId}&author=${galleryState.selectedAuthor}&sort=${galleryState.selectedSortCriteria}`;
            htmx.ajax('GET', url, {
                target: '#media-grid',
                swap: 'innerHTML'
            });
        }

        else if (e.target.id == 'toggle-filters') {
            const filters = document.getElementsByClassName('filter-container')[0];
            galleryState.filterDivState = !galleryState.filterDivState;
            filters.classList.toggle('hidden');
        }
    });

    // Re-apply active class after filter-pills update
    // Update DOM after adding or removing tags
    // related to tags-updated
    // htmx:afterSettle is the safest place to touch the DOM after a swap. It guarantees:
    document.body.addEventListener('htmx:afterSettle', (evt) => {
        if (evt.target.id === 'filter-pills') {
            if (galleryState.filterDivState) {
                console.log('Restoring active pills:', galleryState.selectedTagId, galleryState.selectedAuthor, galleryState.selectedSortCriteria);

                const filters = document.getElementsByClassName('filter-container')[0];
                filters.classList.toggle('hidden');
            }
            const activeTagPill = document.querySelector(`.sorting-pill[data-tag="${galleryState.selectedTagId}"]`);
            if (activeTagPill) {
                activeTagPill.classList.add('active');
            }
            const activeAuthorPill = document.querySelector(`.sorting-pill[data-author="${galleryState.selectedAuthor}"]`);
            if (activeAuthorPill) {
                activeAuthorPill.classList.add('active');
            }
            const activeSortPill = document.querySelector(`.sort-pill[data-sort="${galleryState.selectedSortCriteria}"]`);
            if (activeSortPill) {
                activeSortPill.classList.add('active');
            }
        }
    });
</script>