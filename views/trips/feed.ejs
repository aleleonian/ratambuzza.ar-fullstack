<%- include('../partials/header') %>

<div class="layout">
    <aside class="sidebar left">
        <!-- e.g. Profile / Trip Switcher -->
        <%- include('../partials/sidebar-left', { trips, trip }) %>
    </aside>

    <main class="feed">
        <h2><%= trip.name %></h2>

        <!-- Everything related to creating a new post -->
        <div id="post-controls" class="mobile-only">
            <button class="button showPostForm" style="margin-bottom: 20px;">+ New Post</button>
        </div>

        <!-- Injected post (new post via HTMX) -->
        <div id="post-inject-point"></div>

        <!-- Post list container -->
        <div id="posts-container">
            <% if (posts.length === 0) { %>
            <p>No posts yet for this trip. Be the first to share!</p>
            <% } else { %>
            <!-- Initial posts -->
            <% posts.forEach(post => { %>
            <%- include('../partials/post', { trip, post }) %>
            <% }) %>
            <% } %>
        </div>

        <!-- Fixed: Use hidden input for dynamic offset -->
        <% if (moreUrl) { %>
        <div style="text-align: center; padding: 20px;">
            <input type="hidden" id="current-offset" name="current-offset" value="<%= POSTS_PER_PAGE %>" />
            <!-- <input type="hidden" id="trip-id" name="trip-id" value="<%= trip.id %>" /> -->
            <button id="load-more-btn" hx-get="/trips/<%= trip.slug %>/feed/more" hx-include="#current-offset"
                hx-target="#posts-container" hx-swap="beforeend"
                style="padding: 10px 20px; font-size: 16px; background: #007cba; color: white; border: none; cursor: pointer;">
                Load More Posts
            </button>
            <p>Debug: offset = <span id="offset-display"><%= POSTS_PER_PAGE %></span></p>
        </div>
        <% } %>
    </main>


    <aside class="sidebar right">
        <!-- e.g. Suggested posts / About Ratambuzza -->
        <%- include('../partials/sidebar-right', { trips, trip }) %>
    </aside>
</div>

<script>

    document.body.addEventListener('htmx:afterRequest', (evt) => {
        // Close modal after post form submission
        debugger;
        const triggeringEl = evt.detail?.requestConfig?.elt;
        if (evt.target.closest('form')?.id === 'add-post-form') {
            debugger;
            document.getElementById('postModal')?.classList.add('hidden')
            console.log('üóë Post added ‚Äî updating current-offset');
            const offsetInput = document.getElementById('current-offset');
            // if (offsetInput) {
            //     const current = parseInt(offsetInput.value, 10) || 0;
            //     const newOffset = Math.max(0, current + 1); // prevent negative offset
            //     offsetInput.value = newOffset;
            //     document.getElementById('offset-display').textContent = newOffset;
            // }
        }
        if (triggeringEl?.id === 'delete-post-form') {
            console.log('üóë Post deleted ‚Äî updating current-offset');
            const offsetInput = document.getElementById('current-offset');
            if (offsetInput) {
                const current = parseInt(offsetInput.value, 10) || 0;
                const newOffset = Math.max(0, current - 1); // prevent negative offset
                offsetInput.value = newOffset;
                document.getElementById('offset-display').textContent = newOffset;
            }
        }
    })

    // Load more handling with hidden inputs
    let currentOffset = <%= POSTS_PER_PAGE %>;

    console.log('üîß Setup - currentOffset:', currentOffset);

    document.body.addEventListener('htmx:beforeRequest', (evt) => {
        if (evt.target.id === 'load-more-btn') {
            console.log('üöÄ Button clicked!');
            console.log('  - Offset input value:', document.getElementById('current-offset').value);
            // console.log('  - Trip ID input value:', document.getElementById('trip-id').value);
            console.log('  - hx-get URL:', evt.target.getAttribute('hx-get'));
            evt.target.textContent = 'Loading...';
        }
    });

    document.body.addEventListener('htmx:afterRequest', (evt) => {
        if (evt.target.id === 'load-more-btn') {
            console.log('üì¶ Got response! Status:', evt.detail.xhr.status);

            // Check if the response indicates no more posts
            const responseText = evt.detail.xhr.responseText;
            if (responseText.includes('data-no-more-posts="true"')) {
                console.log('‚ùå No more posts available - disabling button');
                evt.target.disabled = true;
                evt.target.textContent = 'No More Posts';
                evt.target.style.background = '#ccc';
                evt.target.style.cursor = 'not-allowed';
                return; // Don't update offset
            }

            currentOffset += <%= POSTS_PER_PAGE %>;
            document.getElementById('current-offset').value = currentOffset;
            document.getElementById('offset-display').textContent = currentOffset;

            console.log('üîÑ Updated offset input to:', currentOffset);
            evt.target.textContent = 'Load More Posts';
        }
    });
</script>

<div id="postModal" class="modal hidden">
    <div class="modal-content">
        <button id="closePostModal" class="modal-close">‚úñ</button>
        <%- include('../partials/new-post-form', { trip }) %>
    </div>
</div>
<script>
    // Handle all open buttons
    document.querySelectorAll('.showPostForm').forEach((btn) => {
        btn.addEventListener('click', () => {
            document.getElementById('postModal')?.classList.remove('hidden');
            document.getElementById('new-post-content')?.focus();
        });
    });

    // Handle modal close
    document.getElementById('closePostModal')?.addEventListener('click', () => {
        document.getElementById('postModal')?.classList.add('hidden');
    });

    const modal = document.getElementById('postModal')
    // const openBtn = document.getElementById('showPostForm')
    // const closeBtn = document.getElementById('closePostModal')

    // openBtn?.addEventListener('click', () => {
    //     debugger;
    //     modal.classList.remove('hidden')
    // })

    // closeBtn?.addEventListener('click', () => {
    //     modal.classList.add('hidden')
    // })

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            modal?.classList.add('hidden')
        }
    })
</script>
<%- include('../partials/footer') %>