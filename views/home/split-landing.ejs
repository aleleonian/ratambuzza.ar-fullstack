<%- include('../partials/header-split') %>
<%- JSON.stringify(currentOrUpcomingTrip) %>
<%- tripMode %>
<main class="main-container">
    <div class="left"></div>

    <div class="right">
        <div id="title">
            <h1><%- trip.name %></h1>
            <div id="countdown"><span id="timer"></span></div>
        </div>

        <!-- <div id="avatars">
        <div class="avatar-container" data-person="Afro" aria-haspopup="dialog">
            <img src="assets/avatars/Afro.png" alt="Afro" class="avatar" />
            <h5>Afro</h5>
        </div>

        <div class="avatar-container" data-person="Alefa" aria-haspopup="dialog">
            <img src="assets/avatars/Alefa.png" alt="Alefa" class="avatar" />
            <h5>Alefa</h5>
        </div>

        <div class="avatar-container" data-person="Boli" aria-haspopup="dialog">
            <img src="assets/avatars/Boli.png" alt="Boli" class="avatar" />
            <h5>Boli</h5>
        </div>

        <div class="avatar-container" data-person="Butis" aria-haspopup="dialog">
            <img src="assets/avatars/Butis.png" alt="Butis" class="avatar" />
            <h5>Butis</h5>
        </div>

        <div class="avatar-container" data-person="Charly" aria-haspopup="dialog">
            <img src="assets/avatars/Charly.png" alt="Charly" class="avatar" />
            <h5>Charly</h5>
        </div>

        <div class="avatar-container" data-person="Depo" aria-haspopup="dialog">
            <img src="assets/avatars/Depo.png" alt="Depo" class="avatar" />
            <h5>Depo</h5>
        </div>

        <div class="avatar-container" data-person="Firulais" aria-haspopup="dialog">
            <img src="assets/avatars/Firulais.png" alt="Firulais" class="avatar" />
            <h5>Firulais</h5>
        </div>

        <div class="avatar-container" data-person="Látigo" aria-haspopup="dialog">
            <img src="assets/avatars/Latigo.png" alt="Látigo" class="avatar" />
            <h5>Látigo</h5>
        </div>

        <div class="avatar-container" data-person="Marian" aria-haspopup="dialog">
            <img src="assets/avatars/Mariano.png" alt="Marian" class="avatar" />
            <h5>Marian</h5>
        </div>

        <div class="avatar-container" data-person="Patas" aria-haspopup="dialog">
            <img src="assets/avatars/Patas.png" alt="Patas" class="avatar" />
            <h5>Patas</h5>
        </div>

        <div class="avatar-container" data-person="Pato" aria-haspopup="dialog">
            <img src="assets/avatars/Pato.png" alt="Pato" class="avatar" />
            <h5>Pato</h5>
        </div>

        <div class="avatar-container" data-person="Sanchez" aria-haspopup="dialog">
            <img src="assets/avatars/Sanchez.png" alt="Sanchez" class="avatar" />
            <h5>Sanchez</h5>
        </div>

        <div class="avatar-container" data-person="Topo" aria-haspopup="dialog">
            <img src="assets/avatars/Topo.png" alt="Topo" class="avatar" />
            <h5>Topo</h5>
        </div>
    </div> -->
        <div id="avatars" hx-get="/trips/<%= trip.slug %>/crew-fragment" hx-trigger="load" hx-swap="outerHTML">
            <div style="opacity:.6; padding:2rem; text-align:center;">Loading crew…</div>
        </div>
    </div>

    <!-- Dialog -->
    <div class="dialog-overlay" id="personOverlay" aria-hidden="true">
        <div class="person-dialog" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
            <!-- <button class="dlg-close" id="dlgClose" aria-label="Close dialog">✖</button> -->
            <header>
                <img id="dlgAvatar" class="dlg-avatar" alt="">
                <!-- <div>
                    <h2 id="dlgTitle">Name</h2>
                </div> -->
                <div>
                    <p id="dlgBio"></p>
                </div>
            </header>

            <div class="dlg-actions">
                <button class="btn" id="dlgCloseBottom">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Countdown logic
        const countdown = document.getElementById('timer');
        const targetDate = new Date("2025-10-08T00:00:00");

        function updateCountdown() {
            const now = new Date();
            const diff = targetDate - now;

            if (diff <= 0) { countdown.textContent = "Estamos en Rio!"; return; }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((diff / (1000 * 60)) % 60);
            const seconds = Math.floor((diff / 1000) % 60);

            countdown.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
        updateCountdown();
        setInterval(updateCountdown, 1000);

        // TODO: dynamic

        // ===== Person data (stub – tweak freely) =====
        // Use short keys you like; UI capitalizes keys as given.
        const PEOPLE = {
            "Afro": {
                avatar: "assets/avatars/Afro.png",
                bio: "También conocido como 'Gusano' desde chico anheló el sueño Americano. Su talento más grande es no roncar a pesar del nazo que tiene."
            },
            "Alefa": {
                avatar: "assets/avatars/Alefa.png",
                traits: {
                    "Otros apodos:": "Osketti",
                    "Superpoder:": "Te festeja todos los chistes.",
                    "Secreto:": "Es novio de Palermo."
                },
                bio: "También conocido como Oscar, es el público ideal porque te festeja todos los chistes. Vive atormentado por una pesadilla recurrente en donde una pala lo persigue para trabajar en el jardín de la casa de su familia en Pinamar."
            },
            "Boli": {
                avatar: "assets/avatars/Boli.png",
                traits: {
                    "Nombre completo:": "Mónica Brenta Depilación",
                    "Master en:": "Chistes de gangosos",
                    "Talento:": "El helicóptero",
                },
                bio: "Es dueño de una cadena de locales de depilación definitiva. Lo llaman el J.R.R Tolkien de Villa Sarmiento por su capacidad para bolasear. Posee un conocimiento enciclopédico de chistes de gansosos."
            },
            "Butis": {
                avatar: "assets/avatars/Butis.png", traits: { "Superpoder:": "Es la rata más grande", "Talento:": "Tiene el puño más cerrado que un bebé.", "Nunca dijo:": "Vayamos a gastar dinero. " },
                bio: "La rata más grande del condado, tiene el puño más cerrado que un bebé. Prefiere perder un brazo antes que pagar un sobreprecio. Es capaz de sobrevivir varios días internado en una montaña nevada alimentándose de un sánguche. "
            },
            "Charly": { avatar: "assets/avatars/Charly.png", bio: "El dealer de achuras oficial del grupo. Sus mollejas de corazón no tienen rival. Frase que nunca dijo: todas. No pronuncia palabra desde 1993." },
            "Depo": { avatar: "assets/avatars/Depo.png", bio: "También conocido como: Antreli, Galmácido o Dr.G. Si Steve-O de Jackass y Ozzy Osbourne hubieran tenido un hijo, sería Albertito. Ahora es un padre de familia pero en sus años mozos, supo tranzarse una bolsa de basura." },
            "Firulais": { avatar: "assets/avatars/Firulais.png", bio: "Bom-vivant sin igual. Es el último gourmand. En una picada preparada por él, hay quesos de los 5 continentes y mortadela de unicornio. Frase que nunca dijo: 'No puedo irme de viaje, tengo que trabajar.'" },
            "Látigo": { avatar: "assets/avatars/Latigo.png", bio: "Holgazán de nacimiento. Durante años de su vida buscó maneras de no tener que trabajar pero fracasó rotundamente. Hace buenos trucos pero el gran milagro que nadie explica es como una mujer 14 años menor que él le terminó dando bola." },
            "Marian": { avatar: "assets/avatars/Mariano.png", bio: "Hiperactivo como nadie. En un mismo día el doctor es capaz de: escribir un libro, viajar a China, sacarle un pepino del culo a un paciente. Hace poco rompió el record de mayor cantidad de días consecutivos de permanencia en su casa: 3." },
            "Patas": { avatar: "assets/avatars/Patas.png", bio: "Titán de las finanzas, empresario sin igual, borracho. Comenzó bien abajo limpiando baños en Constitución. Un buen día tuvo la idea de crear sus propios productos de limpieza y el resto es historia." },
            "Pato": { avatar: "assets/avatars/Pato.png", bio: "Piloto enduro, empresario gastronómico, modelo publicitario. Otro que ya no sabe que hacer para rajarse de la casa. Compite cabeza a cabeza con Butis a ver quién tiene más alma de roedor." },
            "Sanchez": { avatar: "assets/avatars/Sanchez.png", bio: "Influencer de redes sociales en el mundo de bienes raíces. Lo llaman 'El hacedor' o 'El Grinch'. Nunca vendió un departamento y publica un video cada 3 meses pero igual le tenemos fé." },
            "Topo": { avatar: "assets/avatars/Topo.png", bio: "De jóven era una máquina de hacer deportes, una máquina con varios engranajes menos y sin aceite. El día que correr sin doblar las rodillas sea un deporte olímpico, este pibe va a estar a la altura de Husain Bolt." }
        };

        // ===== Dialog wiring =====
        const overlay = document.getElementById('personOverlay');
        // const dlgClose = document.getElementById('dlgClose');
        const dlgCloseBottom = document.getElementById('dlgCloseBottom');
        const dlgAvatar = document.getElementById('dlgAvatar');
        const dlgTitle = document.getElementById('dlgTitle');
        const kvGrid = document.getElementById('kvGrid');
        const dlgBio = document.getElementById('dlgBio');
        let lastFocus = null;

        function openDialog(personName) {
            const data = PEOPLE[personName];
            if (!data) return;

            dlgAvatar.src = data.avatar;
            dlgAvatar.alt = personName;
            // dlgTitle.textContent = personName;
            dlgBio.textContent = data.bio;
            lastFocus = document.activeElement;
            overlay.setAttribute('aria-hidden', 'false');
            // focus close button for accessibility
            // dlgClose.focus();
            document.addEventListener('keydown', onKeydown);
            // prevent body scroll behind dialog (desktop already fixed, mobile needs this)
            document.body.style.overflow = 'hidden';
        }

        function closeDialog() {
            overlay.setAttribute('aria-hidden', 'true');
            document.removeEventListener('keydown', onKeydown);
            document.body.style.overflow = ''; // restore
            if (lastFocus && lastFocus.focus) lastFocus.focus();
        }

        function onKeydown(e) {
            if (e.key === 'Escape') closeDialog();
            // very light focus trap: loop close buttons
            if (e.key === 'Tab') {
                const focusables = [dlgCloseBottom];
                const idx = focusables.indexOf(document.activeElement);
                if (idx === -1) return;
                e.preventDefault();
                const next = e.shiftKey ? (idx - 1 + focusables.length) % focusables.length
                    : (idx + 1) % focusables.length;
                focusables[next].focus();
            }
        }

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeDialog();
        });
        // dlgClose.addEventListener('click', closeDialog);
        dlgCloseBottom.addEventListener('click', closeDialog);

        // Delegate clicks from grid of avatars
        document.getElementById('avatars').addEventListener('click', (e) => {
            const btn = e.target.closest('.avatar-container');
            if (!btn) return;
            const person = btn.getAttribute('data-person');
            if (person) openDialog(person);
        });

        // Keyboard support on avatars
        document.querySelectorAll('.avatar-container').forEach(el => {
            el.setAttribute('tabindex', '0');
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const person = el.getAttribute('data-person');
                    if (person) openDialog(person);
                }
            });
        });
    </script>

</main>
</body>

</html>