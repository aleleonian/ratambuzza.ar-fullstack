<%- include('../../partials/header/feed-current-upcoming') %>

<div class="layout">
    <aside class="sidebar left">
        <!-- e.g. Profile / Trip Switcher -->
        <%- include('./sidebar-left', { trips, trip }) %>
    </aside>

    <main class="feed">
        <!-- Everything related to creating a new post -->
        <div id="post-controls" class="mobile-only">
            <button class="button showPostForm" style="margin-bottom: 20px;">+ Nuevo</button>
        </div>

        <!-- Post list container -->
        <div id="posts-container">
            <% if (posts.length === 0) { %>
            <p>No posts yet for this trip. Be the first to share!</p>
            <% } else { %>
            <!-- Initial posts -->
            <% posts.forEach(post => { %>
            <%- include('./post', { trip, post }) %>
            <% }) %>
            <% } %>
        </div>

        <!-- Post ID-based pagination -->
        <% if (theresMore) { %>
        <div style="text-align: center; padding: 20px;">
            <input type="hidden" id="exclude-ids" name="exclude_ids" value="" />
            <button id="load-more-btn" hx-get="/trips/<%= trip.slug %>/feed/more" hx-include="#exclude-ids, #search-form"
                hx-target="#posts-container" hx-swap="beforeend" class="button">
                Cargar más posteos
            </button>
        </div>
        <% } %>

        <%- include('../../partials/lightbox-standalone') %>

    </main>


    <aside class="sidebar right">
        <!-- e.g. Suggested posts / About Ratambuzza -->
        <%- include('./sidebar-right', { trips, trip }) %>
    </aside>
</div>

<script>

    // Function to collect all post IDs currently shown
    function updateExcludeIds() {
        const postsContainer = document.getElementById('posts-container');
        const mainPosts = postsContainer.querySelectorAll('[data-post-id]');
        // Combine both sets of posts
        const allPostElements = [...mainPosts];
        const postIds = allPostElements.map(el => el.getAttribute('data-post-id'));


        // document.getElementById('exclude-ids').value = postIds.join(',');
        const input = document.getElementById('exclude-ids');
        if (input) {
            input.value = postIds.join(',');
        }
        return postIds;
    }

    document.body.addEventListener('htmx:afterSwap', (evt) => {
        // Handle post addition - this fires AFTER the DOM is updated
        if (evt.target.id === 'posts-container') {

            setupFeedPostLightbox();

            document.getElementById('postModal')?.classList.add('hidden')

            setTimeout(() => updateExcludeIds(), 50);
        }
    });

    document.body.addEventListener('htmx:afterRequest', (evt) => {
        // Handle post deletion 
        if (evt.detail?.requestConfig?.elt?.closest('form')?.classList?.contains('delete-post-form')) {
            setTimeout(() => updateExcludeIds(), 50);
        }
    })

    // Initialize exclude IDs on page load - collect initial posts
    updateExcludeIds();

    document.body.addEventListener('htmx:beforeRequest', (evt) => {
        if (evt.target.id === 'load-more-btn') {
            const excludeIds = document.getElementById('exclude-ids').value;

            evt.target.textContent = 'Loading...';
        }
    });

    document.body.addEventListener('htmx:afterRequest', (evt) => {
        if (evt.target.id === 'load-more-btn') {
            // Check if the response indicates no more posts
            const responseText = evt.detail.xhr.responseText;
            if (responseText.includes('data-no-more-posts="true"')) {
                evt.target.disabled = true;
                evt.target.textContent = 'No More Posts';
                evt.target.style.background = '#ccc';
                evt.target.style.cursor = 'not-allowed';
                return;
            }

            // Update exclude IDs after new posts are loaded
            setTimeout(() => updateExcludeIds(), 50);
            evt.target.textContent = 'Cargar más posteos';
        }
    });

    // Handle search form functionality
    document.addEventListener('DOMContentLoaded', () => {
        const searchForm = document.getElementById('search-form');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const searchText = document.getElementById('search-text');
        const userFilter = document.getElementById('user-filter');


        // Clear filters functionality
        // Added: 2025-09-16 - Resets search form and reloads page to show all posts
        clearFiltersBtn?.addEventListener('click', () => {
            searchText.value = '';
            userFilter.value = '';
            
            // Reload the page to show all posts
            window.location.reload();
        });

        // Update load more button when search is performed
        // Added: 2025-09-16 - Handles pagination during filtered results
        // When filters are active, hide the "Load More" button since we're showing search results
        // When no filters, restore normal infinite scroll pagination
        document.body.addEventListener('htmx:afterSwap', (evt) => {
            if (evt.target.id === 'posts-container') {
                // Update the load more button to include current search parameters
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (loadMoreBtn && searchForm) {
                    const formData = new FormData(searchForm);
                    const searchParams = new URLSearchParams(formData);
                    
                    // Check if we have any active filters
                    const hasActiveFilters = Array.from(formData.values()).some(value => value.trim() !== '');
                    
                    if (hasActiveFilters) {
                        // When filtering, the load more button should be hidden or disabled
                        // since we're showing search results, not paginated feed
                        loadMoreBtn.style.display = 'none';
                    } else {
                        // When no filters, restore normal pagination
                        loadMoreBtn.style.display = 'block';
                        const baseUrl = `/trips/<%= trip.slug %>/feed/more`;
                        loadMoreBtn.setAttribute('hx-get', baseUrl);
                    }
                }
            }
        });
    });
</script>

<div id="postModal" class="modal hidden">
    <div class="modal-content">
        <button id="closePostModal" class="modal-close">✖</button>
        <%- include('./new-post-form', { trip }) %>
    </div>
</div>
<script>
    // Handle all open buttons
    document.querySelectorAll('.showPostForm').forEach((btn) => {
        btn.addEventListener('click', () => {
            document.getElementById('postModal')?.classList.remove('hidden');
            document.getElementById('new-post-content')?.focus();
        });
    });

    // Handle modal close
    document.getElementById('closePostModal')?.addEventListener('click', () => {
        document.getElementById('postModal')?.classList.add('hidden');
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.getElementById('postModal')?.classList.add('hidden')
        }
    })
</script>

<script>
    function setupFeedPostLightbox() {
        // Loop over each post container
        document.querySelectorAll('.post-images').forEach(postEl => {
            const thumbs = Array.from(postEl.querySelectorAll('.post-image-thumb'));
            if (thumbs.length === 0) return;

            const items = thumbs.map(el => ({
                url: el.dataset.full,
                id: el.dataset.id,
            }));

            thumbs.forEach((el, i) => {
                el.addEventListener('click', () => {
                    initLightbox(items);
                    openLightbox(i);
                });
            });
        });
    }

    document.addEventListener('DOMContentLoaded', setupFeedPostLightbox);

</script>
<%- include('../../partials/footer') %>