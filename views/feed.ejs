<%- include('partials/header') %>

<h2><%= trip.name %></h2>

<% if (posts.length === 0) { %>
<p>No posts yet for this trip. Be the first to share!</p>
<% } else { %>

<!-- Everything related to creating a new post -->
<div id="post-controls">
    <button id="showPostForm" class="button" style="margin-bottom: 20px;">+ New Post</button>

    <div id="postModal" class="modal hidden">
        <div class="modal-content">
            <button id="closePostModal" class="modal-close">âœ–</button>
            <%- include('partials/new-post-form', { trip }) %>
        </div>
    </div>
</div>

<div id="post-inject-point"></div>

<div id="post-list" class="grid">
    <!-- New Post Button -->
    <% posts.forEach(post => { %>
    <div class="card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
            <img src="/images/avatars/thumbs/<%= post.avatar_file_name %>" width="40" height="40"
                style="border-radius: 50%; object-fit: cover;" alt="avatar" />
            <strong>@<%= post.handle %></strong>
            <span style="margin-left:auto; font-size: 10px; color: var(--muted);">
                <%= new Date(post.created_at).toLocaleString() %>
            </span>
        </div>

        <% if (post.content) { %>
        <p><%= post.content %></p>
        <% } %>

        <% if (post.image_filename) { %>
        <div style="margin-top: 12px;">
            <img src="/uploads/<%= post.image_filename %>" alt="Post Image"
                style="max-width: 100%; border-radius: var(--radius);" />
        </div>
        <% } %>
    </div>
    <% }) %>
</div>
<% } %>

<script>
    const modal = document.getElementById('postModal')
    const openBtn = document.getElementById('showPostForm')
    const closeBtn = document.getElementById('closePostModal')

    openBtn.addEventListener('click', () => {
        modal.classList.remove('hidden')
    })

    closeBtn.addEventListener('click', () => {
        modal.classList.add('hidden')
    })

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            modal.classList.add('hidden')
        }
    })
    document.body.addEventListener('htmx:afterRequest', (evt) => {
        // Close modal after post form submission
        if (evt.target.closest('form')?.id === 'newPostForm') {
            document.getElementById('postModal')?.classList.add('hidden')
        }
    })
</script>


<%- include('partials/footer') %>